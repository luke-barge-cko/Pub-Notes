
## Stored Procedures

| Stored Procedures                     | Links                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Action(s)                                                                                                                                                                                                                                                                                           | Suggested Action                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Other                        |                                                                                                                                                                                                                                                                 |                                          |     |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- | --- |
| Amex.GetAdjustmentRecordById          | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/AdjustmentRecord/GetAdjustme                                                                                                                                                                                                                                                                                                                       | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.GetAmexOutgoingSubmissionTABById | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Procedures/Submission/AmexOutgoingSubmissionTAB/GetAmexOut                                                                                                                                                                                                                                                                                     TABById.sql#L18       | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.GetIncomingChargebackById        | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Procedures/IncomingChar                                                                                                                                                                                                                                                                                                                                              | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.GetRecordOfChargeById            | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Proce                                                                                                                                                                                                                                                                                                                      14                                        | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.InsertIncomingRetrievalRequest   | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/Inc                                                                                                                                                                                                                                                                                            InsertIncomingRetrievalRequest.sql#L19              | Masks the Card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                                     | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.UpSertAdjustmentRecord           | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Am                                                                                                                                                                                                                                                                                                            d/UpSertAdjustmentRecord.sql#L11                              | Masks the Card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.UpSertAmexOutgoingSubmissionTAB  | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedu                                                                                                                                                                                                                                                                               ssion/AmexOutgoingSubmissionTAB/UpSertAmexOutgoingSubmissionTAB.sql#L54 | Masks the card number and encrypts with 3DES. This table is currently used in new Amex settlement https://github.com/cko-fort/amex-settlement/blob/main/src/main/java/com/checkout/settlement/amex/clearing/persistence/IntegrationDbRepository.java#L37 and in Amex clearing https://github.com/cko-card-processing/amex-clearing/blob/47c5c235abda0d5320fe542bc871466d1b6f0bfd/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L182. Amex settlement does not decrypt though. Amex clearing does decrypt. Although it looks like this does get passed to the SP as masked (https://github.com/cko-card-processing/amex-clearing/blob/6a30393561359c8b81fe106099b1686b4eab8345/src/Core.Clearing/Application/UseCases/Clearing/ClearingService.cs#L108). We can update the SP and and update the inline code in Amex.Clearing to stop encrypting and decrypting the data. Alternatively, we can leave it because technically the value is always masked, event whilst being encrypted. However, if we leave it, it risks the key being deleted and the inline sql for amex clearing failing | Stop 3DES encrypting and insert encrypted value as as blank. __We must modify the inline sql below prior to this otherwise it will attempt to decrypt a value which is not encrypted. We must not make the masked PAN blank here because it will cause issues with the new Amex settlement loader__ | MODIFY to stop encrypting the card data and instead insert as blank                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | This is also used in Amex US |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.UpSertIncomingChargeback         | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TP                                                                                                                                                                                                                                                                                                        ures/IncomingChargeback/UpSertIncomingChargeback.sql#L74                          | Masks the card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     | DELETE SP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                              |                                                                                                                                                                                                                                                                 |                                          |     |
| Amex.UpSertRecordOfCharge             | https://github.com/cko-card-processing/checkout-tpp-db/blo                                                                                                                                                                                                                                                                                                                d%20Procedures/RecordOfCharge/UpSertRecordOfCharge.sql#L36                                  | Masks the card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     | DELETE SP                                            https://github.com/cko-card-processing/amex-clearing/blob/47c5c235abda0d5320fe542bc871466d1b6f0bfd/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L197.          https://github.com/cko-card-processing/amex-us-settlement/blob/cf5e280a5343a45b0040bc502392192890d8d2c1/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L119-L118 - both Amex clearing and Amex us settlement 1b6f0bfd/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L197. |                              | Stop decrypting and retuning PAN. This will allow use to modify the SP `Amex.UpSertAmexOutgoingSubmissionTAB` to stop encrypting with 3DES. __Impact of this is not known__. Theoretically we can leave this as the value in the IntegrationDB is double masked | MODIFY This to stop decrypting card data |     |

## IntegrationDB 
- Needs to be done after SPs

| TABLE                     | ACTION(S)                                                                                                                                                            | Suggested Action                 | Other                                                                             |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------- | --------------------------------------------------------------------------------- |
| IncomingRetrievalRequest  | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       | PURGE PAN DATA, leave masked PAN | This is also used in dispute exporter but I don't think card number is referenced |
| AdjustmentRecord          | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       | PURGE PAN DATA, leave masked PAN |                                                                                   |
| AmexOutgoingSubmissionTAB | Purge PAN after above Inline SQL has been modified. __We cannot make the PAN blank because this will break the new Amex settlement loader as well as Amex clearing__ | PURGE PAN DATA, leave masked PAN | This table is used in Checkout-CP- Amex                                           |
| IncomingChargeback        | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       | PURGE PAN DATA, leave masked PAN |                                                                                   |
| RecordOfCharge            | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       | PURGE PAN DATA, leave masked PAN |                                                                                   |

## Snowflake

In the old Amex-Event-Exporter (This will be decommissioned), the RetrievalRequestReceived used to send data to snowflake with 3DES encryption. The new Amex-Settlement project sends the data as encrypted. We will need to purge data from snowflake which was inserted prior to this move. The impact of this is unknown.

## ROWS 

| SchemaName | TableName                 | Rows_Count |
| ---------- | ------------------------- | ---------- |
| Amex       | IncomingRetrievalRequest  | 29,651     |
| Amex       | AdjustmentRecord          | 147,498    |
| Amex       | AmexOutgoingSubmissionTAB | 62,429,105 |
| Amex       | IncomingChargeback        | 16,146,8   |
| Amex       | RecordOfCharge            | 29,165,013 |

## N.B.

The IntegrationDB is directly coupled 10s-100s of services. This work includes deleting data read by an unknown number of stakeholders. I have identified multiple breaking problems in services which we are not responsible. I identified these by chance, I do not have a realistic way of aggregating all possible breaking changes to services I do not know exist. Moreover, I do not have a way to test any of the changes locally or in QA. It seems like a very high chance that things will go wrong. 

## ToDo
- Need to remove cypher key from Amex Clearing
- Look at cp-sf-access-control
- Look at clearing snowflake project - Archived
	- Need to check data previously exported from here is compliant

## MISC

```sql
SELECT TOP 10000  
    CCNumber,  
    CASE  
        WHEN CCNumber LIKE '%*%' THEN 'Contains stars'  
        ELSE 'Does not contain stars'  
    END AS ContainsStarrs  
FROM Amex.AmexOutgoingSubmissionTAB  
ORDER BY NEWID();
```



- sql server used to be main db
- no capture details on musql
- we need 
- Have a chat with Kavir about this
- How does the 
- Get access to snowflake! 
- Need ask if we need to support refunds