
## Stored Procedures

| Stored Procedures                                          | Links                                                                                                                                                                                                  | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Action                                                                                                                                                                                                                                                                                              |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Amex.GetAdjustmentRecordById                               | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/AdjustmentRecord/GetAdjustmentRecordById.sql#L12                                    | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          |
| Amex.GetAmexOutgoingSubmissionTABById                      | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Procedures/Submission/AmexOutgoingSubmissionTAB/GetAmexOutgoingSubmissionTABById.sql#L18              | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          |
| Amex.GetIncomingChargebackById                             | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Procedures/IncomingChargeback/GetIncomingChargebackById.sql#L14                                       | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          |
| Amex.GetRecordOfChargeById                                 | https://github.com/cko-card-processing/checkout-tpp-db/blob/master/TPP/INTEGRATION/Amex/Stored%20Procedures/RecordOfCharge/GetRecordOfChargeById.sql#L14                                               | Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Stop decrypting and returning decrypted  PAN and instead return blank PAN, __No impact observed__. This can probably be deleted completely                                                                                                                                                          |
| Amex.InsertIncomingRetrievalRequest                        | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/IncomingRetrievalRequest/InsertIncomingRetrievalRequest.sql#L19                     | Masks the Card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                                     |
| Amex.UpSertAdjustmentRecord                                | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/AdjustmentRecord/UpSertAdjustmentRecord.sql#L11                                     | Masks the Card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     |
| Amex.UpSertAmexOutgoingSubmissionTAB                       | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/Submission/AmexOutgoingSubmissionTAB/UpSertAmexOutgoingSubmissionTAB.sql#L54        | Masks the card number and encrypts with 3DES. This table is currently used in new Amex settlement https://github.com/cko-fort/amex-settlement/blob/main/src/main/java/com/checkout/settlement/amex/clearing/persistence/IntegrationDbRepository.java#L37 and in Amex clearing https://github.com/cko-card-processing/amex-clearing/blob/47c5c235abda0d5320fe542bc871466d1b6f0bfd/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L182. Amex settlement does not decrypt though. Amex clearing does decrypt. Although it looks like this does get passed to the SP as masked (https://github.com/cko-card-processing/amex-clearing/blob/6a30393561359c8b81fe106099b1686b4eab8345/src/Core.Clearing/Application/UseCases/Clearing/ClearingService.cs#L108). We can update the SP and and update the inline code in Amex.Clearing to stop encrypting and decrypting the data. Alternatively, we can leave it because technically the value is always masked, event whilst being encrypted. However, if we leave it, it risks the key being deleted and the inline sql for amex clearing failing | Stop 3DES encrypting and insert encrypted value as as blank. __We must modify the inline sql below prior to this otherwise it will attempt to decrypt a value which is not encrypted. We must not make the masked PAN blank here because it will cause issues with the new Amex settlement loader__ |
| Amex.UpSertIncomingChargeback                              | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/IncomingChargeback/UpSertIncomingChargeback.sql#L74                                 | Masks the card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     |
| Amex.UpSertRecordOfCharge                                  | https://github.com/cko-card-processing/checkout-tpp-db/blob/task/CPK-2991/TPP/INTEGRATION/Amex/Stored%20Procedures/RecordOfCharge/UpSertRecordOfCharge.sql#L36                                         | Masks the card number and encrypts with 3DES. Not used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Stop 3DES encrypting and insert encrypted value as as blank, __No impact observed__. This can probably be deleted completely. We can probably also modify to insert PAN as blank and not masked                                                                                                     |
| Incline SQL which SELECTS from `AmexOutgoingSubmissionTAB` | https://github.com/cko-card-processing/amex-clearing/blob/47c5c235abda0d5320fe542bc871466d1b6f0bfd/src/Infrastructure/Persistence/Repositories/MsSql/LegacyAmexOutgoingSubmissionTabRepository.cs#L197 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Stop decrypting and retuning PAN. This will allow use to modify the SP `Amex.UpSertAmexOutgoingSubmissionTAB` to stop encrypting with 3DES. __Impact of this is not known__. Theoretically we can leave this as the value in the IntegrationDB is double masked                                     |

## IntegrationDB

| TABLE                     | ACTION                                                                                                                                                               |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| IncomingRetrievalRequest  | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       |
| AdjustmentRecord          | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       |
| AmexOutgoingSubmissionTAB | Purge PAN after above Inline SQL has been modified. __We cannot make the PAN blank because this will break the new Amex settlement loader as well as Amex clearing__ |
| IncomingChargeback        | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       |
| RecordOfCharge            | Purge 3DES PAN. We can probably make the masked PAN blank also                                                                                                       |

## Snowflake

In the old Amex-Event-Exporter (This will be decommissioned), the RetrievalRequestReceived used to send data to snowflake with 3DES encryption. The new Amex-Settlement project sends the data as masked. We will need to purge data from snowflake which was inserted prior to this move. The impact of this is unknown.





